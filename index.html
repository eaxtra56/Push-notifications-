<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Firebase Push Notification ডিবাগ পেজ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            padding: 20px; 
            line-height: 1.6;
        }
        button { 
            font-size: 1.2rem; 
            padding: 10px 20px; 
            cursor: pointer; 
            margin-bottom: 20px;
        }
        #debug-log {
            list-style-type: none;
            padding: 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #debug-log li {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        #debug-log li:last-child {
            border-bottom: none;
        }
        .success {
            color: #28a745; /* সবুজ */
            font-weight: bold;
        }
        .error {
            color: #dc3545; /* লাল */
            font-weight: bold;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            word-wrap: break-word;
            white-space: pre-wrap; /* লাইন ব্রেক করার জন্য */
        }
    </style>
</head>
<body>

    <h1>Firebase Push Notification ডিবাগ পেজ</h1>
    <p>নিচের বাটনে ক্লিক করুন এবং প্রতিটি ধাপের ফলাফল দেখুন।</p>
    <button id="permission-btn">পরীক্ষা শুরু করুন</button>
    
    <h3>ধাপে ধাপে লগ:</h3>
    <ul id="debug-log"></ul>

    <h3>বিস্তারিত ত্রুটি (যদি থাকে):</h3>
    <pre id="error-details">কোনো ত্রুটি নেই...</pre>

    <h3>আপনার ডিভাইস টোকেন:</h3>
    <pre id="token-display">এখানে টোকেন দেখানো হবে...</pre>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
      import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-messaging.js";

const firebaseConfig = {
    apiKey: "AIzaSyBkEurB8a1xfrzE1yT4scdf801ovdq5-rw",
    authDomain: "guild-f8843.firebaseapp.com",
    databaseURL: "https://guild-f8843-default-rtdb.firebaseio.com",
    projectId: "guild-f8843",
    storageBucket: "guild-f8843.firebasestorage.app",
    messagingSenderId: "959781172981",
    appId: "1:959781172981:web:593da4b7610ae7db83b7bc"
  }; 
      
      const VAPID_KEY = "BBFbOiyfdCgSUg8vTjIMT6scojec2-nYAhyVOAfCXs17kWI73t4Z3K53HXDUOTblBbAdrXmxAAcKbBWZrGPlL9Q";

      // --- ডিবাগিং এর জন্য UI এলিমেন্ট ---
      const permissionBtn = document.getElementById('permission-btn');
      const logContainer = document.getElementById('debug-log');
      const tokenDisplay = document.getElementById('token-display');
      const errorDisplay = document.getElementById('error-details');

      // --- লগ দেখানোর জন্য হেলপার ফাংশন ---
      function logStatus(message, type = '') {
          const li = document.createElement('li');
          li.textContent = message;
          if (type) {
              li.className = type;
          }
          logContainer.appendChild(li);
      }

      function logError(error) {
          console.error("একটি ত্রুটি ঘটেছে:", error); // কনসোলেও লগ করা হলো
          errorDisplay.textContent = `Error Message: ${error.message}\n\nError Code: ${error.code}\n\nStack Trace:\n${error.stack}`;
      }

      permissionBtn.onclick = async function() {
          // প্রতিবার ক্লিকের সময় পুরনো লগ পরিষ্কার করা হচ্ছে
          logContainer.innerHTML = '';
          errorDisplay.textContent = 'কোনো ত্রুটি নেই...';
          tokenDisplay.textContent = 'এখানে টোকেন দেখানো হবে...';

          try {
              // ধাপ ১: Firebase অ্যাপ ইনিশিয়ালাইজ করা
              logStatus("ধাপ ১: Firebase অ্যাপ ইনিশিয়ালাইজ করা হচ্ছে...");
              const app = initializeApp(firebaseConfig);
              logStatus("✅ ধাপ ১: Firebase সফলভাবে ইনিশিয়ালাইজ হয়েছে।", "success");
              
              const messaging = getMessaging(app);

              // ধাপ ২: সার্ভিস ওয়ার্কার রেজিস্টার করা
              logStatus("ধাপ ২: সার্ভিস ওয়ার্কার রেজিস্টার করা হচ্ছে (./firebase-messaging-sw.js)...");
              const swRegistration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
              logStatus(`✅ ধাপ ২: সার্ভিস ওয়ার্কার সফলভাবে রেজিস্টার হয়েছে। Scope: ${swRegistration.scope}`, "success");

              // ধাপ ৩: নোটিফিকেশনের অনুমতি চাওয়া
              logStatus("ধাপ ৩: নোটিফিকেশনের অনুমতির জন্য অনুরোধ করা হচ্ছে...");
              const permission = await Notification.requestPermission();
              
              if (permission === 'granted') {
                  logStatus("✅ ধাপ ৩: ব্যবহারকারী অনুমতি দিয়েছেন।", "success");

                  // ধাপ ৪: FCM টোকেন সংগ্রহ করা
                  logStatus("ধাপ ৪: FCM ডিভাইস টোকেন সংগ্রহ করা হচ্ছে...");
                  const currentToken = await getToken(messaging, {
                      vapidKey: VAPID_KEY,
                      serviceWorkerRegistration: swRegistration
                  });

                  if (currentToken) {
                      logStatus("✅ ধাপ ৪: ডিভাইস টোকেন সফলভাবে পাওয়া গেছে।", "success");
                      tokenDisplay.textContent = currentToken;
                  } else {
                      logStatus("❌ ধাপ ৪: টোকেন পাওয়া যায়নি। ব্রাউজার বা সার্ভিস ওয়ার্কারে সমস্যা থাকতে পারে।", "error");
                      logError(new Error("getToken() returned no token. This often means the service worker is not set up correctly."));
                  }

              } else {
                  logStatus(`❌ ধাপ ৩: ব্যবহারকারী অনুমতি দেননি। Permission state: ${permission}`, "error");
                  logError(new Error("Notification permission was not granted by the user."));
              }

          } catch (err) {
              logStatus(`❌ একটি মারাত্মক ত্রুটি ঘটেছে!`, "error");
              logError(err);
          }
      };
    </script>
</body>
</html>


